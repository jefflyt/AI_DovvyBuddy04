# PR1: Database Schema & Migrations

**Branch Name:** `feature/pr1-database-schema`  
**Status:** ✅ Complete  
**Date:** December 22, 2025  
**Completed:** December 31, 2025  
**Based on:** MASTER_PLAN.md (Phase 1: Foundations & Data Layer)

---

## 1. Feature/Epic Summary

### Objective

Establish the persistent data layer for DovvyBuddy, including database schema, migrations tooling, and seed data for the initial destination and dive sites.

### User Impact

- **Internal/Foundation:** No direct user-facing impact in this PR.
- **Enables:** Future PRs (PR2-PR5) that depend on persistent storage for RAG embeddings, sessions, and lead capture.
- **Developer Experience:** Provides type-safe database access patterns and reproducible schema setup.

### Dependencies

- **Upstream:** PR0 (Bootstrap) — Complete ✅
- **External:**
  - Postgres instance on Neon with pgvector extension support — ✅ Complete
  - Database credentials (`DATABASE_URL`) — ✅ Configured

### Assumptions

- **Assumption:** Postgres instance provisioned on Neon — ✅ Complete
- **Assumption:** pgvector extension enabled via SQL — ✅ Verified
- **Assumption:** Initial seed data includes 1 destination (Tioman Island, Malaysia) with 5 dive sites — ✅ Complete
- **Assumption:** Vector embeddings use 768 dimensions (Gemini gemini-embedding-001 standard) — ✅ Implemented
- **Assumption:** HNSW index used for vector similarity search — ✅ Implemented

---

## 2. Implementation Summary

### What Was Built

**Database Foundation:**
- ✅ Installed Drizzle ORM (v0.45.1), Drizzle Kit (v0.31.8), postgres (v3.4.7), tsx (v4.21.0), dotenv (v17.2.3)
- ✅ Configured Drizzle Kit for migrations (`drizzle.config.ts`)
- ✅ Created database connection utility (`src/db/client.ts`)

**Database Schema (5 Tables):**
- ✅ `destinations` — Dive destinations metadata
- ✅ `dive_sites` — Dive sites with certifications & difficulty requirements
- ✅ `leads` — Lead capture submissions (training/trip)
- ✅ `sessions` — Chat session state with 24h expiry
- ✅ `content_embeddings` — RAG vector embeddings (768 dimensions)

**Database Tooling:**
- ✅ Migration generation (`pnpm db:generate`)
- ✅ Migration application (`pnpm db:migrate`)
- ✅ Schema push for development (`pnpm db:push`)
- ✅ Drizzle Studio for visual DB exploration (`pnpm db:studio`)
- ✅ Seed script with Tioman Island data (`pnpm db:seed`)
- ✅ Database clearing utility (`pnpm db:clear`)
- ✅ Verification script (`src/db/verify.ts`)

**Documentation:**
- ✅ Comprehensive database README (`src/db/README.md`) with table schemas, usage examples, scripts, and troubleshooting
- ✅ Updated `.env.example` with DATABASE_URL
- ✅ All schema files documented with TypeScript types

### Seed Data

**Destination:** Tioman Island, Malaysia

**Dive Sites (5):**
1. **Tiger Reef** — Intermediate (AOW, 20+ dives)
2. **Batu Malang** — Beginner (OW, 0 dives)
3. **Pulau Chebeh** — Intermediate (AOW, 10+ dives)
4. **Pulau Labas** — Intermediate (OW, 10+ dives)
5. **Renggis Island** — Beginner (OW, 0 dives)

### Verification Results

**✅ All Checks Passed:**
- **TypeScript:** No type errors
- **ESLint:** No linting errors (TypeScript version warning is informational only)
- **Build:** Next.js production build successful
- **Tests:** All tests pass (2/2)
- **Database:** All tables created, pgvector enabled, seed data verified
- **Verification Script:** 1 destination + 5 dive sites confirmed

---

## 3. Complexity & Fit

### Classification

**Single-PR**

### Rationale

- **Limited Scope:** Schema definition + migration setup + seed script.
- **No User-Facing Changes:** Backend-only, no API endpoints or UI.
- **Single Layer:** Data layer only; no frontend or API logic.
- **Low Risk:** Additive changes only (new tables); no existing data to migrate.
- **Testable:** Can be verified via direct DB queries and type-checking.
- **Estimated Effort:** 1-2 days for solo founder (schema design, tooling setup, seed data creation, testing).

---

## 4. Full-Stack Impact

### Frontend

**No changes planned.**

### Backend

**Indirect impact (foundation only):**

- Database connection utility will be created but not consumed in this PR.
- No API routes added in this PR.
- Schema types generated by Drizzle will be available for future PRs.

### Data

**Core changes:**

- **New Tables:**
  - `destinations` — Store destination metadata (name, country, active status).
  - `dive_sites` — Store dive site details (linked to destinations, certification requirements, difficulty).
  - `leads` — Store training and trip lead submissions.
  - `sessions` — Store guest session state and conversation history.
  - `content_embeddings` — Store chunked content with vector embeddings for RAG retrieval.
- **Extensions:**
  - Enable `pgvector` extension for vector similarity search.
  - Enable `uuid-ossp` extension for UUID generation (if not default).
- **Migrations:**
  - Initial migration: Create all 5 tables + enable extensions.
  - Migration tooling: Drizzle Kit for versioned SQL migrations.
- **Seed Data:**
  - 1 destination record (e.g., "Cozumel, Mexico").
  - 5-10 dive site records linked to the destination.
  - Sample metadata for testing (certification levels, difficulty bands, access types).

### Infra / Config

- **Environment Variables:**
  - Add `DATABASE_URL` to `.env.example`.
  - Document format (e.g., `postgresql://user:password@host:port/database?sslmode=require`).
- **Package Dependencies:**
  - Add `drizzle-orm` (ORM).
  - Add `drizzle-kit` (Migration tooling).
  - Add `postgres` or `pg` (Postgres client).
  - Add `dotenv` (Environment variable loading for scripts).
- **Scripts:**
  - Add `pnpm db:migrate` — Run pending migrations.
  - Add `pnpm db:seed` — Populate seed data.
  - Add `pnpm db:push` — Push schema changes (dev only).
  - Add `pnpm db:studio` (optional) — Launch Drizzle Studio for DB exploration.

---

## 5. PR Roadmap

### PR1: Database Schema & Migrations

**Goal**  
Set up the persistent storage layer with type-safe schema definitions, migration tooling, and seed data for local and production environments.

---

### Scope

**In scope:**

- Install Drizzle ORM, Drizzle Kit, and Postgres driver.
- Create schema definitions for 5 tables in `src/db/schema/`.
- Configure Drizzle Kit for migrations (`drizzle.config.ts`).
- Generate initial migration SQL files.
- Create database connection utility (`src/db/client.ts`).
- Create seed script (`src/db/seed.ts`) for 1 destination with 5-10 sites.
- Update `package.json` with database-related scripts.
- Update `.env.example` with `DATABASE_URL`.
- Add basic README in `src/db/` documenting schema and commands.

**Out of scope:**

- API endpoints (deferred to PR3).
- RAG content ingestion (deferred to PR2).
- Session management service (deferred to PR3).
- Lead capture logic (deferred to PR4).
- UI components (deferred to PR5).

---

### Backend Changes

**Database Connection Utility (`src/db/client.ts`):**

- Export a singleton Postgres connection pool using Drizzle.
- Handle connection errors gracefully with retries.
- Support connection pooling configuration via environment variables.

**Schema Definitions (`src/db/schema/`):**

- **`destinations.ts`:**
  ```
  - id: UUID (primary key, default uuid_generate_v4())
  - name: TEXT (not null)
  - country: TEXT (not null)
  - is_active: BOOLEAN (default true)
  - created_at: TIMESTAMP (default now())
  ```
- **`dive_sites.ts`:**
  ```
  - id: UUID (primary key)
  - destination_id: UUID (foreign key → destinations.id)
  - name: TEXT (not null)
  - description: TEXT (nullable)
  - min_certification_level: TEXT (e.g., "OW", "AOW", "Rescue")
  - min_logged_dives: INTEGER (nullable)
  - difficulty_band: TEXT (e.g., "beginner", "intermediate", "advanced")
  - access_type: TEXT (e.g., "shore", "boat")
  - is_active: BOOLEAN (default true)
  - created_at: TIMESTAMP (default now())
  ```
- **`leads.ts`:**
  ```
  - id: UUID (primary key)
  - type: TEXT (enum: "training" | "trip")
  - diver_profile: JSONB (stores: agency, level, dive_count, etc.)
  - request_details: JSONB (stores: location, dates, interests, etc.)
  - created_at: TIMESTAMP (default now())
  ```
- **`sessions.ts`:**
  ```
  - id: UUID (primary key)
  - diver_profile: JSONB (nullable, stores session-level diver context)
  - conversation_history: JSONB (array of {role, message, timestamp})
  - created_at: TIMESTAMP (default now())
  - expires_at: TIMESTAMP (not null, default now() + 24 hours)
  ```
- **`content_embeddings.ts`:**
  ```
  - id: UUID (primary key)
  - content_path: TEXT (e.g., "certifications/padi-open-water.md")
  - chunk_text: TEXT (the actual text chunk)
  - embedding: VECTOR(768) (pgvector type, 768 dimensions for Gemini gemini-embedding-001)
  - metadata: JSONB (e.g., {section, tags, source})
  - created_at: TIMESTAMP (default now())
  ```

**Migration Configuration (`drizzle.config.ts`):**

- Configure Drizzle Kit to:
  - Read schema from `src/db/schema/`.
  - Output migrations to `src/db/migrations/`.
  - Connect using `DATABASE_URL` from environment.

**Seed Script (`src/db/seed.ts`):**

- ✅ Inserts 1 destination: Tioman Island, Malaysia
- ✅ Inserts 5 dive sites:
  - Tiger Reef (intermediate, AOW, 20+ dives)
  - Batu Malang (beginner, OW, 0 dives)
  - Pulau Chebeh (intermediate, AOW, 10+ dives)
  - Pulau Labas (intermediate, OW, 10+ dives)
  - Renggis Island (beginner, OW, 0 dives)
- ✅ Uses Drizzle ORM insert methods
- ✅ Script is idempotent (checks for existing data before inserting)
- ✅ Additional utilities: `db:clear` script for database cleanup
- **Note:** Partner shop data (mentioned in MASTER_PLAN) is deferred to PR4 (Lead Capture) when lead delivery logic is implemented. For V1, leads are delivered via email/webhook rather than mapped to specific shops in the database.

---

### Frontend Changes

**No changes planned.**

---

### Data Changes

**Migrations:**

- **Migration 1:** `0001_initial_schema.sql`
  - Enable `uuid-ossp` extension.
  - Enable `pgvector` extension.
  - Create `destinations` table.
  - Create `dive_sites` table with foreign key to `destinations`.
  - Create `leads` table.
  - Create `sessions` table.
  - Create `content_embeddings` table with vector column.
  - Create indexes:
    - `dive_sites.destination_id` (foreign key index).
    - `sessions.expires_at` (for cleanup queries).
    - `content_embeddings.embedding` (HNSW index for vector search).

**Backward Compatibility:**

- Not applicable (greenfield schema).

---

### Infra / Config

**Environment Variables (`.env.example`):**

```
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/dovvybuddy?sslmode=require

# Session (used in PR3, added here for completeness)
SESSION_SECRET=your_random_32_char_string_here

# Future variables (not used in PR1)
# LLM_PROVIDER=groq
# GROQ_API_KEY=
# GEMINI_API_KEY=
```

**Package Scripts (`package.json`):**

```
"db:generate": "drizzle-kit generate",
"db:migrate": "drizzle-kit migrate",
"db:push": "drizzle-kit push",
"db:studio": "drizzle-kit studio",
"db:seed": "tsx --env-file=.env.local src/db/seed.ts",
"db:clear": "tsx --env-file=.env.local src/db/clear.ts"
```

**Dependencies Added:**

- ✅ `drizzle-orm` (v0.45.1) — Type-safe ORM
- ✅ `drizzle-kit` (v0.31.8) — Migration tooling
- ✅ `postgres` (v3.4.7) — Postgres client
- ✅ `tsx` (v4.21.0) — TypeScript execution for seed script
- ✅ `dotenv` (v17.2.3) — Load environment variables in Node scripts

---

### Testing

**Unit Tests:**

- **Schema Validation:**
  - Test that schema definitions export correct table types.
  - Verify Drizzle types match expected TypeScript interfaces.
- **Connection Utility:**
  - Mock connection and verify retry logic.
  - Test connection pool configuration.

**Integration Tests:**

- **Migration Execution:**
  - Run migrations against a test database.
  - Verify all tables created with correct columns and types.
  - Verify indexes exist.
- **Seed Script:**
  - Run seed script against test database.
  - Query database to verify seed data inserted.
  - Run seed script twice to verify idempotency.

**Manual Checks:**

- Connect to local/dev database using `psql` or Drizzle Studio.
- Inspect schema with `\dt` (tables), `\d <table>` (table details).
- Query seed data: `SELECT * FROM destinations;` and `SELECT * FROM dive_sites;`.

---

### Verification

**Commands:**

1. **Install Dependencies:**

   ```
   pnpm install
   ```

2. **Set Up Environment:**
   - Copy `.env.example` to `.env.local`.
   - Update `DATABASE_URL` with actual Postgres credentials.

3. **Generate Migration:**

   ```
   pnpm db:generate
   ```

   - Expected: Migration SQL file created in `src/db/migrations/`.

4. **Run Migration:**

   ```
   pnpm db:migrate
   ```

   - Expected: All tables created in database, no errors.

5. **Run Seed Script:**

   ```
   pnpm db:seed
   ```

   - Expected: Seed data inserted, success message logged.

6. **Verify Schema (Manual):**
   - Connect to database: `psql $DATABASE_URL`
   - List tables: `\dt`
   - Expected: `destinations`, `dive_sites`, `leads`, `sessions`, `content_embeddings`.
   - Inspect table: `\d destinations`
   - Expected: Columns match schema definition.

7. **Verify Seed Data (Manual):**

   ```sql
   SELECT * FROM destinations;
   SELECT * FROM dive_sites;
   ```

   - Expected: 1 destination, 5-10 dive sites.

8. **Type Check:**

   ```
   pnpm typecheck
   ```

   - Expected: No type errors.

9. **Lint:**

   ```
   pnpm lint
   ```

   - Expected: No lint errors.

10. **Run Tests:**

    ```
    pnpm test
    ```

    - Expected: All tests pass.

**Manual Verification Checklist:**

- [x] Database tables exist with correct schema.
- [x] pgvector extension enabled (`SELECT * FROM pg_extension WHERE extname = 'vector';`).
- [x] Seed data inserted and queryable (1 destination, 5 dive sites).
- [x] Foreign key constraints work (verified via schema push).
- [x] Vector column accepts embeddings (VECTOR(768) type created).
- [x] Drizzle types are exported and usable in TypeScript files.
- [x] Verification script confirms database state.
- [x] All CI checks pass (lint, typecheck, build, test).

---

### Rollback Plan

**Feature Flag / Kill Switch:**

- Not applicable (no user-facing features or API routes).

**Revert Strategy:**

- If PR is reverted:
  - Database schema will remain (migrations are not auto-reversed).
  - Manual rollback: Drop tables or run `DOWN` migration if implemented.
  - No data loss risk (only seed data, which is reproducible).
- **Migration Rollback (if needed):**
  - Create a `down` migration script to drop all tables.
  - Document rollback command in `src/db/README.md`.

---

### Dependencies

**Upstream PRs:**

- PR0 (Bootstrap) — Complete ✅

**External Dependencies:**

- Postgres instance provisioned on Neon.
- `DATABASE_URL` available in environment.
- pgvector extension available on Neon instance.

---

### Risks & Mitigations

**Risk 1: pgvector Extension Not Available**

- **Mitigation:** Verify pgvector support before starting. Neon supports pgvector natively. Document fallback plan (use JSONB for embeddings if vector extension fails).

**Risk 2: Migration Failures on Remote Database**

- **Mitigation:** Test migrations locally first. Use connection pooling with retries. Log detailed error messages.

**Risk 3: Seed Data Conflicts (Non-Idempotent Script)**

- **Mitigation:** Make seed script check for existing data before inserting (e.g., `SELECT COUNT(*) FROM destinations WHERE name = 'Cozumel'`). Use `ON CONFLICT DO NOTHING` for inserts.

**Risk 4: Type Mismatches Between Drizzle Schema and SQL**

- **Mitigation:** Use Drizzle Kit's `introspect` command to validate schema matches actual database. Write integration tests that insert/query data.

**Risk 5: Connection Pool Exhaustion**

- **Mitigation:** Configure connection pool limits (`max` connections). Use connection pooling best practices. Document pool configuration in `src/db/client.ts`.

---

## 6. Milestones & Sequence

### Milestone 1: Database Foundation Ready

**What it unlocks:** Database schema and tooling ready for PR2 (RAG content ingestion) and PR3 (Session/Lead APIs).

**PRs included:** PR1 only.

**Definition of Done:**

- [x] All 5 tables created with correct schema.
- [x] pgvector extension enabled.
- [x] Migration tooling configured and tested.
- [x] Seed data loaded successfully (Tioman Island + 5 dive sites).
- [x] Connection utility tested and exported.
- [x] TypeScript types generated and verified.
- [x] CI passes (lint, typecheck, test, build).
- [x] Documentation added (`src/db/README.md`).
- [x] Verification script created (`src/db/verify.ts`).
- [x] Database clearing utility added (`src/db/clear.ts`).

---

## 7. Risks, Trade-offs, and Open Questions

### Major Risks

1. **pgvector Compatibility:** If pgvector is not available, embedding storage will need alternative approach (JSONB array).
   - **Mitigation:** Verify provider support upfront. Document fallback strategy.
2. **Schema Evolution:** Future schema changes may require complex migrations.
   - **Mitigation:** Design schema with extensibility in mind (use JSONB for flexible fields). Plan for additive changes.
3. **Seed Data Maintenance:** Seed data may become outdated or inconsistent.
   - **Mitigation:** Version seed data in git. Add validation checks to seed script.

### Trade-offs

1. **Drizzle vs Prisma:** Chose Drizzle for better cold start performance and lighter bundle size.
   - **Trade-off:** Drizzle has smaller community and fewer integrations than Prisma.
   - **Decision:** Acceptable for V1; performance matters more for serverless.
2. **Normalized vs Denormalized:** Chose normalized schema (separate tables for destinations/sites).
   - **Trade-off:** More joins required for queries.
   - **Decision:** Acceptable for V1 scale; easier to maintain and extend.
3. **UUID vs Serial IDs:** Chose UUIDs for all primary keys.
   - **Trade-off:** Slightly larger storage footprint; better for distributed systems and merge-safe.
   - **Decision:** Acceptable; future-proofs for multi-region or sharding.

### Design Decisions

| Topic | Decision | Rationale |
|-------|----------|--------|
| **Postgres Provider** | Neon | Better cold start performance, excellent pgvector support |
| **ORM** | Drizzle | Lighter bundle size than Prisma, better serverless performance |
| **Vector Dimensions** | 768 dimensions | Gemini `gemini-embedding-001` standard; column: `VECTOR(768)` |
| **Vector Index** | HNSW | Better recall and query performance than IVFFlat |
| **Primary Keys** | UUID v4 | Distributed-friendly, merge-safe, better for future sharding |
| **Schema Design** | Normalized | Separate tables for destinations/sites; easier to maintain and extend |
| **Session Storage** | JSONB columns | Flexible for conversation history and diver profile data |
| **Seed Data Source** | Reference `content/destinations/` files | Real Tioman Island data from content files; keeps seed data consistent with RAG content |
| **Data Quality Criteria** | `verified` = official sources (PADI, dive shops); `compiled` = aggregated from multiple reviews/forums; `anecdotal` = single source or personal experience | Clear criteria for content trust levels |

### Future Enhancements

- **Session cleanup job** via cron or Vercel scheduled functions
- **GIN index on metadata** JSONB for faster filtering
- **Read replicas** for production scale
- **Multi-region setup** with connection pooling optimization

---

## Appendix: File Structure

```
src/
├── db/
│   ├── client.ts                    # Database connection utility
│   ├── schema/
│   │   ├── index.ts                 # Re-export all schemas
│   │   ├── destinations.ts          # Destinations table schema
│   │   ├── dive-sites.ts            # Dive sites table schema
│   │   ├── leads.ts                 # Leads table schema
│   │   ├── sessions.ts              # Sessions table schema
│   │   └── content-embeddings.ts    # Content embeddings table schema
│   ├── migrations/
│   │   ├── 0000_enable_extensions.sql   # Enable pgvector extension
│   │   ├── 0000_jittery_maddog.sql      # Initial schema migration
│   │   └── meta/                        # Drizzle migration metadata
│   ├── seed.ts                      # Seed script (Tioman Island data)
│   ├── clear.ts                     # Database clearing utility
│   ├── verify.ts                    # Verification script
│   ├── enable-extensions.ts         # Extension setup script
│   └── README.md                    # Database documentation

drizzle.config.ts                     # Drizzle Kit configuration
```

---

**End of PR1 Plan**
