# PR1: Database Schema & Migrations

**Branch Name:** `feature/pr1-database-schema`  
**Status:** Planned  
**Date:** December 22, 2025  
**Based on:** MASTER_PLAN.md (Phase 1: Foundations & Data Layer)

---

## 1. Feature/Epic Summary

### Objective
Establish the persistent data layer for DovvyBuddy, including database schema, migrations tooling, and seed data for the initial destination and dive sites.

### User Impact
- **Internal/Foundation:** No direct user-facing impact in this PR.
- **Enables:** Future PRs (PR2-PR5) that depend on persistent storage for RAG embeddings, sessions, and lead capture.
- **Developer Experience:** Provides type-safe database access patterns and reproducible schema setup.

### Dependencies
- **Upstream:** PR0 (Bootstrap) — Complete ✅
- **External:** 
  - Postgres instance on Neon with pgvector extension support.
  - Database credentials (`DATABASE_URL`).

### Assumptions
- **Assumption:** Postgres instance will be provisioned on Neon before PR implementation starts.
- **Assumption:** pgvector extension can be enabled via SQL (Neon supports this).
- **Assumption:** Initial seed data will include 1 destination (e.g., "Cozumel, Mexico") with 5-10 dive sites and basic metadata.
- **Assumption:** Vector embeddings will use 1536 dimensions (Gemini text-embedding-004 standard).
- **Assumption:** HNSW index will be used for vector similarity search.

---

## 2. Complexity & Fit

### Classification
**Single-PR**

### Rationale
- **Limited Scope:** Schema definition + migration setup + seed script.
- **No User-Facing Changes:** Backend-only, no API endpoints or UI.
- **Single Layer:** Data layer only; no frontend or API logic.
- **Low Risk:** Additive changes only (new tables); no existing data to migrate.
- **Testable:** Can be verified via direct DB queries and type-checking.
- **Estimated Effort:** 1-2 days for solo founder (schema design, tooling setup, seed data creation, testing).

---

## 3. Full-Stack Impact

### Frontend
**No changes planned.**

### Backend
**Indirect impact (foundation only):**
- Database connection utility will be created but not consumed in this PR.
- No API routes added in this PR.
- Schema types generated by Drizzle will be available for future PRs.

### Data
**Core changes:**
- **New Tables:**
  - `destinations` — Store destination metadata (name, country, active status).
  - `dive_sites` — Store dive site details (linked to destinations, certification requirements, difficulty).
  - `leads` — Store training and trip lead submissions.
  - `sessions` — Store guest session state and conversation history.
  - `content_embeddings` — Store chunked content with vector embeddings for RAG retrieval.
- **Extensions:**
  - Enable `pgvector` extension for vector similarity search.
  - Enable `uuid-ossp` extension for UUID generation (if not default).
- **Migrations:**
  - Initial migration: Create all 5 tables + enable extensions.
  - Migration tooling: Drizzle Kit for versioned SQL migrations.
- **Seed Data:**
  - 1 destination record (e.g., "Cozumel, Mexico").
  - 5-10 dive site records linked to the destination.
  - Sample metadata for testing (certification levels, difficulty bands, access types).

### Infra / Config
- **Environment Variables:**
  - Add `DATABASE_URL` to `.env.example`.
  - Document format (e.g., `postgresql://user:password@host:port/database?sslmode=require`).
- **Package Dependencies:**
  - Add `drizzle-orm` (ORM).
  - Add `drizzle-kit` (Migration tooling).
  - Add `postgres` or `pg` (Postgres client).
  - Add `dotenv` (Environment variable loading for scripts).
- **Scripts:**
  - Add `pnpm db:migrate` — Run pending migrations.
  - Add `pnpm db:seed` — Populate seed data.
  - Add `pnpm db:push` — Push schema changes (dev only).
  - Add `pnpm db:studio` (optional) — Launch Drizzle Studio for DB exploration.

---

## 4. PR Roadmap

### PR1: Database Schema & Migrations

**Goal**  
Set up the persistent storage layer with type-safe schema definitions, migration tooling, and seed data for local and production environments.

---

### Scope

**In scope:**
- Install Drizzle ORM, Drizzle Kit, and Postgres driver.
- Create schema definitions for 5 tables in `src/db/schema/`.
- Configure Drizzle Kit for migrations (`drizzle.config.ts`).
- Generate initial migration SQL files.
- Create database connection utility (`src/db/client.ts`).
- Create seed script (`src/db/seed.ts`) for 1 destination with 5-10 sites.
- Update `package.json` with database-related scripts.
- Update `.env.example` with `DATABASE_URL`.
- Add basic README in `src/db/` documenting schema and commands.

**Out of scope:**
- API endpoints (deferred to PR3).
- RAG content ingestion (deferred to PR2).
- Session management service (deferred to PR3).
- Lead capture logic (deferred to PR4).
- UI components (deferred to PR5).

---

### Backend Changes

**Database Connection Utility (`src/db/client.ts`):**
- Export a singleton Postgres connection pool using Drizzle.
- Handle connection errors gracefully with retries.
- Support connection pooling configuration via environment variables.

**Schema Definitions (`src/db/schema/`):**
- **`destinations.ts`:**
  ```
  - id: UUID (primary key, default uuid_generate_v4())
  - name: TEXT (not null)
  - country: TEXT (not null)
  - is_active: BOOLEAN (default true)
  - created_at: TIMESTAMP (default now())
  ```
- **`dive_sites.ts`:**
  ```
  - id: UUID (primary key)
  - destination_id: UUID (foreign key → destinations.id)
  - name: TEXT (not null)
  - description: TEXT (nullable)
  - min_certification_level: TEXT (e.g., "OW", "AOW", "Rescue")
  - min_logged_dives: INTEGER (nullable)
  - difficulty_band: TEXT (e.g., "beginner", "intermediate", "advanced")
  - access_type: TEXT (e.g., "shore", "boat")
  - is_active: BOOLEAN (default true)
  - created_at: TIMESTAMP (default now())
  ```
- **`leads.ts`:**
  ```
  - id: UUID (primary key)
  - type: TEXT (enum: "training" | "trip")
  - diver_profile: JSONB (stores: agency, level, dive_count, etc.)
  - request_details: JSONB (stores: location, dates, interests, etc.)
  - created_at: TIMESTAMP (default now())
  ```
- **`sessions.ts`:**
  ```
  - id: UUID (primary key)
  - diver_profile: JSONB (nullable, stores session-level diver context)
  - conversation_history: JSONB (array of {role, message, timestamp})
  - created_at: TIMESTAMP (default now())
  - expires_at: TIMESTAMP (not null, default now() + 24 hours)
  ```
- **`content_embeddings.ts`:**
  ```
  - id: UUID (primary key)
  - content_path: TEXT (e.g., "certifications/padi-open-water.md")
  - chunk_text: TEXT (the actual text chunk)
  - embedding: VECTOR(1536) (pgvector type, 1536 dimensions for Gemini text-embedding-004)
  - metadata: JSONB (e.g., {section, tags, source})
  - created_at: TIMESTAMP (default now())
  ```

**Migration Configuration (`drizzle.config.ts`):**
- Configure Drizzle Kit to:
  - Read schema from `src/db/schema/`.
  - Output migrations to `src/db/migrations/`.
  - Connect using `DATABASE_URL` from environment.

**Seed Script (`src/db/seed.ts`):**
- Insert 1 destination (e.g., "Cozumel, Mexico").
- Insert 5-10 dive sites:
  - Mix of difficulty levels (beginner, intermediate, advanced).
  - Variety of certification requirements (OW, AOW, Rescue).
  - Mix of access types (shore, boat).
- Use Drizzle ORM insert methods.
- Make script idempotent (check if seed data exists before inserting).

---

### Frontend Changes

**No changes planned.**

---

### Data Changes

**Migrations:**
- **Migration 1:** `0001_initial_schema.sql`
  - Enable `uuid-ossp` extension.
  - Enable `pgvector` extension.
  - Create `destinations` table.
  - Create `dive_sites` table with foreign key to `destinations`.
  - Create `leads` table.
  - Create `sessions` table.
  - Create `content_embeddings` table with vector column.
  - Create indexes:
    - `dive_sites.destination_id` (foreign key index).
    - `sessions.expires_at` (for cleanup queries).
    - `content_embeddings.embedding` (HNSW index for vector search).

**Backward Compatibility:**
- Not applicable (greenfield schema).

---

### Infra / Config

**Environment Variables (`.env.example`):**
```
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/dovvybuddy?sslmode=require

# Future variables (not used in PR1)
# LLM_PROVIDER=groq
# GROQ_API_KEY=
# GEMINI_API_KEY=
```

**Package Scripts (`package.json`):**
```
"db:migrate": "drizzle-kit push:pg",
"db:seed": "tsx src/db/seed.ts",
"db:generate": "drizzle-kit generate:pg",
"db:studio": "drizzle-kit studio"
```

**Dependencies to Add:**
- `drizzle-orm` — Type-safe ORM.
- `drizzle-kit` — Migration tooling.
- `postgres` — Postgres client (or `pg` as alternative).
- `tsx` — TypeScript execution for seed script.
- `dotenv` — Load environment variables in Node scripts.

---

### Testing

**Unit Tests:**
- **Schema Validation:**
  - Test that schema definitions export correct table types.
  - Verify Drizzle types match expected TypeScript interfaces.
- **Connection Utility:**
  - Mock connection and verify retry logic.
  - Test connection pool configuration.

**Integration Tests:**
- **Migration Execution:**
  - Run migrations against a test database.
  - Verify all tables created with correct columns and types.
  - Verify indexes exist.
- **Seed Script:**
  - Run seed script against test database.
  - Query database to verify seed data inserted.
  - Run seed script twice to verify idempotency.

**Manual Checks:**
- Connect to local/dev database using `psql` or Drizzle Studio.
- Inspect schema with `\dt` (tables), `\d <table>` (table details).
- Query seed data: `SELECT * FROM destinations;` and `SELECT * FROM dive_sites;`.

---

### Verification

**Commands:**
1. **Install Dependencies:**
   ```
   pnpm install
   ```

2. **Set Up Environment:**
   - Copy `.env.example` to `.env`.
   - Update `DATABASE_URL` with actual Postgres credentials.

3. **Generate Migration:**
   ```
   pnpm db:generate
   ```
   - Expected: Migration SQL file created in `src/db/migrations/`.

4. **Run Migration:**
   ```
   pnpm db:migrate
   ```
   - Expected: All tables created in database, no errors.

5. **Run Seed Script:**
   ```
   pnpm db:seed
   ```
   - Expected: Seed data inserted, success message logged.

6. **Verify Schema (Manual):**
   - Connect to database: `psql $DATABASE_URL`
   - List tables: `\dt`
   - Expected: `destinations`, `dive_sites`, `leads`, `sessions`, `content_embeddings`.
   - Inspect table: `\d destinations`
   - Expected: Columns match schema definition.

7. **Verify Seed Data (Manual):**
   ```sql
   SELECT * FROM destinations;
   SELECT * FROM dive_sites;
   ```
   - Expected: 1 destination, 5-10 dive sites.

8. **Type Check:**
   ```
   pnpm typecheck
   ```
   - Expected: No type errors.

9. **Lint:**
   ```
   pnpm lint
   ```
   - Expected: No lint errors.

10. **Run Tests:**
    ```
    pnpm test
    ```
    - Expected: All tests pass.

**Manual Verification Checklist:**
- [ ] Database tables exist with correct schema.
- [ ] pgvector extension enabled (`SELECT * FROM pg_extension WHERE extname = 'vector';`).
- [ ] Seed data inserted and queryable.
- [ ] Foreign key constraints work (try inserting dive_site with invalid destination_id).
- [ ] Vector column accepts embeddings (test with sample INSERT).
- [ ] Drizzle types are exported and usable in TypeScript files.

---

### Rollback Plan

**Feature Flag / Kill Switch:**
- Not applicable (no user-facing features or API routes).

**Revert Strategy:**
- If PR is reverted:
  - Database schema will remain (migrations are not auto-reversed).
  - Manual rollback: Drop tables or run `DOWN` migration if implemented.
  - No data loss risk (only seed data, which is reproducible).
- **Migration Rollback (if needed):**
  - Create a `down` migration script to drop all tables.
  - Document rollback command in `src/db/README.md`.

---

### Dependencies

**Upstream PRs:**
- PR0 (Bootstrap) — Complete ✅

**External Dependencies:**
- Postgres instance provisioned on Neon.
- `DATABASE_URL` available in environment.
- pgvector extension available on Neon instance.

---

### Risks & Mitigations

**Risk 1: pgvector Extension Not Available**
- **Mitigation:** Verify pgvector support before starting. Neon supports pgvector natively. Document fallback plan (use JSONB for embeddings if vector extension fails).

**Risk 2: Migration Failures on Remote Database**
- **Mitigation:** Test migrations locally first. Use connection pooling with retries. Log detailed error messages.

**Risk 3: Seed Data Conflicts (Non-Idempotent Script)**
- **Mitigation:** Make seed script check for existing data before inserting (e.g., `SELECT COUNT(*) FROM destinations WHERE name = 'Cozumel'`). Use `ON CONFLICT DO NOTHING` for inserts.

**Risk 4: Type Mismatches Between Drizzle Schema and SQL**
- **Mitigation:** Use Drizzle Kit's `introspect` command to validate schema matches actual database. Write integration tests that insert/query data.

**Risk 5: Connection Pool Exhaustion**
- **Mitigation:** Configure connection pool limits (`max` connections). Use connection pooling best practices. Document pool configuration in `src/db/client.ts`.

---

## 5. Milestones & Sequence

### Milestone 1: Database Foundation Ready
**What it unlocks:** Database schema and tooling ready for PR2 (RAG content ingestion) and PR3 (Session/Lead APIs).

**PRs included:** PR1 only.

**Definition of Done:**
- [ ] All 5 tables created with correct schema.
- [ ] pgvector extension enabled.
- [ ] Migration tooling configured and tested.
- [ ] Seed data loaded successfully.
- [ ] Connection utility tested and exported.
- [ ] TypeScript types generated and verified.
- [ ] CI passes (lint, typecheck, test, build).
- [ ] Documentation added (`src/db/README.md`).

---

## 6. Risks, Trade-offs, and Open Questions

### Major Risks
1. **pgvector Compatibility:** If pgvector is not available, embedding storage will need alternative approach (JSONB array).
   - **Mitigation:** Verify provider support upfront. Document fallback strategy.
2. **Schema Evolution:** Future schema changes may require complex migrations.
   - **Mitigation:** Design schema with extensibility in mind (use JSONB for flexible fields). Plan for additive changes.
3. **Seed Data Maintenance:** Seed data may become outdated or inconsistent.
   - **Mitigation:** Version seed data in git. Add validation checks to seed script.

### Trade-offs
1. **Drizzle vs Prisma:** Chose Drizzle for better cold start performance and lighter bundle size.
   - **Trade-off:** Drizzle has smaller community and fewer integrations than Prisma.
   - **Decision:** Acceptable for V1; performance matters more for serverless.
2. **Normalized vs Denormalized:** Chose normalized schema (separate tables for destinations/sites).
   - **Trade-off:** More joins required for queries.
   - **Decision:** Acceptable for V1 scale; easier to maintain and extend.
3. **UUID vs Serial IDs:** Chose UUIDs for all primary keys.
   - **Trade-off:** Slightly larger storage footprint; better for distributed systems and merge-safe.
   - **Decision:** Acceptable; future-proofs for multi-region or sharding.

### Open Questions

**All questions resolved:**

1. **Which Postgres Provider (Neon vs Supabase)?**
   - **Decision:** ✅ **Neon** — Chosen for cold start performance and excellent pgvector support.
   - **Impact on Plan:** None (plan already compatible).

2. **Vector Dimension Size?**
   - **Decision:** ✅ **1536 dimensions** — Using Gemini text-embedding-004 standard.
   - **Impact on Plan:** Column definition in `content_embeddings.ts` uses `VECTOR(1536)`.

3. **Index Strategy for Vector Search?**
   - **Decision:** ✅ **HNSW** — Chosen for better recall and query performance.
   - **Impact on Plan:** Migration SQL will create HNSW index on `content_embeddings.embedding`.

---

## Appendix: File Structure

```
src/
├── db/
│   ├── client.ts                  # Database connection utility
│   ├── schema/
│   │   ├── index.ts               # Re-export all schemas
│   │   ├── destinations.ts        # Destinations table schema
│   │   ├── dive-sites.ts          # Dive sites table schema
│   │   ├── leads.ts               # Leads table schema
│   │   ├── sessions.ts            # Sessions table schema
│   │   └── content-embeddings.ts  # Content embeddings table schema
│   ├── migrations/
│   │   └── 0001_initial_schema.sql  # Generated migration
│   ├── seed.ts                    # Seed script
│   └── README.md                  # Database documentation
```

---

**End of PR1 Plan**
